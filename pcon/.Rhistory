# 2. load in the OA - PCON lookup table from SQL
myconn <- odbcConnect(dsn = "Datalab", uid = "", pwd = "")
mytables <- sqlTables(channel = myconn)
oapconlookup <- sqlFetch(channel = myconn, sqtable = "SC.OAPCONlookup")
odbcClose(channel = myconn) # close the database connection
rm(mytables) # tidy up by removing the list of tables
# 1. Set up the work
library(pacman) # load pacman package manager
p_load(RODBC, dplyr, tidyr, ggplot2, stringr)
# 2. load in the OA - PCON lookup table from SQL
myconn <- odbcConnect(dsn = "Datalab", uid = "", pwd = "")
mytables <- sqlTables(channel = myconn)
oapconlookup <- sqlFetch(channel = myconn, sqtable = "SC.OAPCONlookup")
odbcClose(channel = myconn) # close the database connection
rm(mytables) # tidy up by removing the list of tables
# 3. read in the census input data at oa level
oac_raw_kvars <- read.csv("T:\7 GIS files\2011 Output Area Classification\2011 OAC 60 Variables\2011_OAC_Raw_kVariables.csv")
oac_raw_kvars <- read.csv("\\Datalab\Shared\7 GIS files\2011 Output Area Classification\2011 OAC 60 Variables\2011_OAC_Raw_kVariables.csv")
setwd("T:/7 GIS files/2011 Output Area Classification/2011 OAC 60 Variables")
oac_raw_kvars <- read.csv("2011_OAC_Raw_kVariables.csv")
head(oapconlookup)
head(oac_raw_kvars)
??left_join
# 4. join the relevant pcon code to the oac_raw_kvars dataframe
oac_raw_kvars_pcon <- left_join(x = oac_raw_kvars, y = oapconlookup, by = c("OA" = "OA11CD"))
head(oac_raw_kvars_pcon)
pcon_agg <- oac_raw_kvars_pcon %>%
group_by(PCON11CD, PCON11NM) %>%
summarise_each(funs(sum)) %>%
summarise(noac = n(OA))
?dplyr::count
pcon_agg <- oac_raw_kvars_pcon %>%
group_by(PCON11CD, PCON11NM) %>%
summarise_each(funs(sum)) %>%
summarise(noac = n())
?dplyr::summarise_each
pcon_agg <- oac_raw_kvars_pcon %>%
group_by(PCON11CD, PCON11NM) %>%
summarise_each(funs(sum), -OA) %>%
summarise(noac = n())
head(pcon_agg)
pcon_agg <- oac_raw_kvars_pcon %>%
group_by(PCON11CD, PCON11NM) %>%
summarise_each(funs(sum), -OA)
head(pcon_agg)
View(pcon_agg)
pcon_agg <- oac_raw_kvars_pcon %>%
group_by(PCON11CD, PCON11NM) %>%
mutate(noac = n(OA))
pcon_agg <- oac_raw_kvars_pcon %>%
group_by(PCON11CD, PCON11NM) %>%
mutate(noac = n())
View(pcon_agg)
table(pcon_agg$PCON11CD, pcon_agg$noac)
pcon_agg <- oac_raw_kvars_pcon %>%
group_by(PCON11CD, PCON11NM) %>%
summarise(noac = n()) %>%
summarise_each(funs(sum), -OA)
pcon_agg <- oac_raw_kvars_pcon %>%
group_by(PCON11CD, PCON11NM) %>%
summarise_each(funs(sum))
pcon_agg <- oac_raw_kvars_pcon %>%
group_by(PCON11CD, PCON11NM) %>%
summarise_each(funs(sum), -OA)
pcon_oac_counts <- oac_raw_kvars_pcon %>%
group_by(PCON11CD, PCON11NM) %>%
summarise(noac = n())
View(pcon_oac_counts)
pcon_oac_counts <- oac_raw_kvars_pcon %>%
group_by(PCON11CD, PCON11NM) %>%
summarise(num_oa = n())
pcon_agg_counts <- left_join(x = pcon_agg, y = pcon_oac_counts, by = "PCON11CD")
View(pcon_agg_counts)
pcon_agg_counts <- left_join(x = pcon_agg, y = pcon_oac_counts, by = c("PCON11CD", "PCON11NM")
)
View(pcon_agg_counts)
?write.csv
setwd("T:/7 GIS files/2011 Output Area Classification/2011 OAC R Code/Meena R code and files")
write.csv(x = pcon_agg_counts, file = "pcon_raw_60_kvariables.csv")
source('~/GitHub/2011OAC/pcon/aggregate_oa_to_pcon.R')
setwd("~/GitHub/2011OAC/pcon")
setwd("~/GitHub/2011OAC/pcon")
write.csv(x = pcon_agg_counts, file = "pcon_raw_60_kvariables.csv")
?select
names(pcon_agg_counts)
getwd()
# 8. Set up a df without the number of OAs column and the pcon name column
pcon_final <- select(.data = pcon_agg_counts, -PCON11NM, -num_oa)
# 8. write out the new table to a csv file
write.csv(x = pcon_final, file = "pcon_raw_60_kvariables.csv")
# repeat to the server
write.csv(x = pcon_final, file = "T:/7 GIS files/2011 Output Area Classification/2011 OAC R Code/PCON Classification R Code/pcon_raw_60_kvariables.csv")
?read.csv
?write.csv
# 8. write out the new table to a csv file
write.csv(x = pcon_final, file = "pcon_raw_60_kvariables.csv", row.names = FALSE)
# repeat to the server
write.csv(x = pcon_final, file = "T:/7 GIS files/2011 Output Area Classification/2011 OAC R Code/PCON Classification R Code/pcon_raw_60_kvariables.csv", row.names = FALSE)
tail(pcon_final)
pcon_final <- pcon_final[-574,]
# 8. write out the new table to a csv file
write.csv(x = pcon_final, file = "pcon_raw_60_kvariables.csv", row.names = FALSE)
# repeat to the server
write.csv(x = pcon_final, file = "T:/7 GIS files/2011 Output Area Classification/2011 OAC R Code/PCON Classification R Code/pcon_raw_60_kvariables.csv", row.names = FALSE)
## END ##
pcon_final <- select(.data = pcon_agg_counts, -PCON11NM, -num_oa)
write.csv(x = pcon_final, file = "pcon_raw_60_kvariables.csv", row.names = FALSE)
# drop the final row which is all the OAs (489808) that weren't joined up to a PCON - I think these are outside of England and Wales
pcon_final <- pcon_final[-574,]
# 8. write out the new table to a csv file
write.csv(x = pcon_final, file = "pcon_raw_60_kvariables.csv", row.names = FALSE)
# repeat to the server
write.csv(x = pcon_final, file = "T:/7 GIS files/2011 Output Area Classification/2011 OAC R Code/PCON Classification R Code/pcon_raw_60_kvariables.csv", row.names = FALSE)
## END ##
